<?php
// $Id$

/**
 * Simple debug function for use during developmet.
 *
 * @param $data
 *   The data that is to be debugged.
 */
function debug($data) {
  $message = '<pre>'. var_export($data, TRUE) .'</pre>';
  drupal_set_message($message, 'status', FALSE);
}

/**
 * Implementation of hook_init().
 */
function icon_init() {
  // Add icon stylesheet file, if one has been generated.
  // @TODO Actually rewrite CSS files.
  $stylesheet = variable_get('icon_stylesheet', NULL);
  if ($stylesheet) {
    drupal_add_css(file_directory_path() .'/css/icons/'. $stylesheet);
  }
}

/**
 * Implementation of hook_perm().
 */
function icon_perm() {
  return array('administer icons');
}

/**
 * Implementation of hook_theme().
 */
function icon_theme() {
  return array(
    'icon_iconsets_form' => array(
      'arguments' => array('form' => NULL),
    ),
  );
}

/**
 * Implementation of hook_menu().
 */
function icon_menu() {
  // Global settings:
  $items['admin/build/icons'] = array(
    'title' => 'Icons',
    'description' => 'Administer icon sets and choose which icons to use.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('icon_settings_form'),
    'access arguments' => array('administer icons'),
  );
  $items['admin/build/icons/settings'] = array(
    'title' => 'Settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );

  // Icon configuration for enabled themes:
  require_once('includes/theme.inc');
  foreach (list_themes() as $key => $theme) {
    if ($theme->status) {
      $items['admin/build/icons/'. $key] = array(
        'title' => $theme->info['name'],
        'page callback' => 'drupal_get_form',
        'page arguments' => array('icon_iconsets_form', $key),
        'access arguments' => array('administer icons'),
        'type' => MENU_LOCAL_TASK,
      );
      $items['admin/build/icons/'. $key .'/iconsets'] = array(
        'title' => 'Icon sets',
        'type' => MENU_DEFAULT_LOCAL_TASK,
        'weight' => -10,
      );
      $items['admin/build/icons/'. $key .'/select'] = array(
        'title' => 'Icons',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('icon_icons_form', $key),
        'access arguments' => array('administer icons'),
        'type' => MENU_LOCAL_TASK,
      );
    }
  }

  return $items;
}

/**
 * Menu callback; displays configuration options for all themes.
 */
function icon_settings_form(&$form_state) {
  $form['todo'] = array(
    '#value' => t('Configuration options that affect all themes.'),
  );
  return $form;
}

/**
 * Menu callback; displays a listing of all icon sets.
 */
function icon_iconsets_form(&$form_state, $theme) {
  // Get all icon sets available to this theme.
  $iconsets = icon_get_iconsets($theme);

  // Sort the icon sets.
  uasort($iconsets, 'icon_sort_iconsets_by_name');

  $status = array();

  // Add form elements for each icon set:
  foreach ($iconsets as $iconset) {
    if (file_exists($iconsets[$iconset->name]->info['screenshot'])) {
      $screenshot = theme('image', $iconsets[$iconset->name]->info['screenshot'], t('Screenshot for %iconset icon set', array('%iconset' => $iconset->info['name'])), '', array('class' => 'screenshot'), FALSE);
    }
    else {
      $screenshot = t('no screenshot');
    }

    $form[$iconset->name]['screenshot'] = array('#value' => $screenshot);

    $form[$iconset->name]['info'] = array(
      '#type' => 'value',
      '#value' => $iconset->info,
    );

    $options[$iconset->name] = '';
    if (!empty($iconset->status)) {
      $status[] = $iconset->name;
    }
  }

  // Pass on the theme name to the form processing function.
  $form['theme'] = array(
    '#type' => 'value',
    '#value' => $theme,
  );

  $form['status'] = array(
    '#type' => 'checkboxes',
    '#options' => $options,
    '#default_value' => $status,
  );

  $form['buttons']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save configuration'),
  );
  $form['buttons']['reset'] = array(
    '#type' => 'submit',
    '#value' => t('Reset to defaults'),
  );

  return $form;
}

/**
 * Process icon_iconsets_form form submissions.
 */
function icon_iconsets_form_submit($form, &$form_state) {
  $theme = $form_state['values']['theme'];

  // Delete all icon set entries for the selected theme.
  db_query("DELETE FROM {iconsets} WHERE theme = '%s'", $theme);

  // Save the statuses of all icon sets for the selected theme.
  if ($form_state['values']['op'] == t('Save configuration')) {
    if (is_array($form_state['values']['status'])) {
      foreach ($form_state['values']['status'] as $key => $choice) {
        db_query("INSERT INTO {iconsets} (iconset, theme, status) VALUES ('%s', '%s', %d)", $key, $theme, $choice ? 1 : 0);
      }
    }
  }
  else {
    // Revert to defaults.
  }

  drupal_set_message(t('The configuration options have been saved.'));
}

/**
 * Menu callback; displays a listing of all icons available to the theme.
 */
function icon_icons_form(&$form_state, $theme) {
/*
 * Get data about all available icons for the specified theme into an array ($icons) [icon_get_icons()]
 * For each $icons[iconset][size]
 *   Present the icon as option element in a table
 */
  $form['todo'] = array(
    '#value' => t('UI for selecting icons for the %theme theme.', array('%theme' => $theme)),
  );
  return $form;
}

/**
 * Collect data about all icon sets available to the specified theme.
 *
 * @param $theme (optional)
 *   Name of the theme to get icon sets for. If omitted, all icon sets will be
 *   returned.
 * @return
 *   Array of all available icon sets and their data.
 */
function icon_get_iconsets($theme = NULL) {
  $defaults = icon_iconset_defaults();
  $iconsets = icon_find_iconsets();

  // Update icon sets from existing {system} entries.
  system_get_files_database($iconsets, 'iconset');

  // Delete all icon sets from {system}.
  db_query("DELETE FROM {system} WHERE type = 'iconset'");

  foreach ($iconsets as $key => $iconset) {
    // Add data from .info file.
    $iconsets[$key]->info = drupal_parse_info_file($iconset->filename) + $defaults;

    if (!empty($iconset->info['screenshot'])) {
      $iconsets[$key]->info['screenshot'] = dirname($iconset->filename) .'/'. $iconset->info['screenshot'];
    }

    // Store all discovered icon sets in {system}.
    db_query("INSERT INTO {system} (name, owner, info, type, filename, status, throttle, bootstrap) VALUES ('%s', '%s', '%s', '%s', '%s', %d, %d, %d)", $iconset->name, '', serialize($iconset->info), 'iconset', $iconset->filename, $iconset->status, 0, 0);
  }

  // Add icon set statuses if fetching icon sets for a specific theme.
  if (is_string($theme)) {
    $result = db_query("SELECT iconset, status FROM {iconsets} WHERE theme = '%s'", $theme);
    while ($item = db_fetch_object($result)) {
      if ($iconsets[$item->iconset]) $iconsets[$item->iconset]->status = $item->status;
    }
  }

  return $iconsets;
}

/**
 * Find all available icon sets.
 *
 * @return
 *   An array of available icon sets.
 */
function icon_find_iconsets() {
  // Get a list of available generic icon sets.
  $iconsets = drupal_system_listing('\.info$', 'icons', 'name', 0);

  // Add any icon sets from enabled system components.
  $result = db_query("SELECT filename, name FROM {system} WHERE type <> 'iconset' AND status = 1 ORDER BY weight DESC");
  while ($component = db_fetch_object($result)) {
    $iconset = file_scan_directory(dirname($component->filename) .'/icons', '\.info$', array('.', '..', 'CVS'), 0, FALSE, 'name');
    $iconsets = array_merge($iconsets, $iconset);
  }

  return $iconsets;
}

/**
 * Collect data about all icons available to the specified theme.
 *
 * @param $theme
 *   Name of the theme for which to get available icons.
 * @return
 *   An array of available icons for the specified theme.
 */
function icon_get_icons($theme) {
/*
 * Get an array of enabled icon sets for the current theme [icon_get_iconsets($theme, TRUE)]
 * For each of the available icon sets
 *   Get the "size" and "icons" arrays from their info
 *   Add the data to an array as $icons[iconset][size][icon]
 * Return the array of icons
 */  
}

/**
 * Array sorting callback; sorts icon sets by their name.
 */
function icon_sort_iconsets_by_name($a, $b) {
  return strcasecmp($a->info['name'], $b->info['name']);
}

/**
 * Prepare defaults for icon sets.
 *
 * @return
 *   An array of default icon set settings.
 */
function icon_iconset_defaults() {
  return array(
    'description' => '',
    'screenshot' => 'screenshot.png',
  );
}

/**
 * Theme function for the icon sets overview form.
 *
 * @param $form
 *   An associative array containing the structure of the form.
 */
function theme_icon_iconsets_form($form) {
  foreach (element_children($form) as $key) {
    if (!isset($form[$key]['info'])) {
      continue;
    }

    $info = $form[$key]['info']['#value'];

    $description = t($info['description']);

    $status = drupal_render($form['status'][$key]);

    $iconset = '<div class="iconset-info"><h2>'. $info['name'] .'</h2><div class="description">'. $description .'</div></div>';

    $row = array();
    $row[] = drupal_render($form[$key]['screenshot']);
    $row[] = $iconset;
    $row[] = array('data' => $status, 'align' => 'center');
    $rows[] = $row;
  }

  $header = array(t('Screenshot'), t('Name'), t('Enabled'));
  $output = theme('table', $header, $rows);
  $output .= drupal_render($form);
  return $output;
}
